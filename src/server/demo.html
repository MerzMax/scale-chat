<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Scale-Chat</title>
        <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
        <script>

            window.onload = function () {
                // The messageId will be increased for each message that will be sent.
                var messageId = 0

                resetInputFields()

                if (!("WebSocket" in window)) {
                    alert("WebSocket NOT supported by your Browser!");
                    return;
                }
                
                let socket = new WebSocket("ws://" + document.location.host + "/ws");

                // RECEIVING MESSAGES
                socket.onopen = function(event) {
                    displayStatusMessage("Connection established!", true)
                }

                socket.onclose = function(event) {
                    if (event.wasClean) {
                        displayStatusMessage(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`, false)
                    } else {
                        displayStatusMessage("[close] Connection died (e.g. server process killed or network down)", false)
                    }
                }

                socket.onerror = function(error) {
                    console.log(`Error: ${error.message}`);
                }

                socket.onmessage = function(event) {
                    var data = JSON.parse(event.data)

                    // Filter all messages that were sent by the user itself
                    if(data.sender != document.getElementById("userIdInput").value) {
                        displayIncommingChatMessage(data)
                    }
                    
                }
                
                // SENDING MESSAGES
                document.getElementById("inputArea").onsubmit = function () {
                    if (!socket) {
                        displayStatusMessage("No WebSocket connection established. Reload to retry.", false);
                        return false;
                    }

                    if (!userIdInput.value) {
                        displayStatusMessage("Please input a user id.", false)
                        return false;
                    } 

                    if(!messageInput.value) {
                        displayStatusMessage("Please input a message.", false)
                        return false;
                    }

                    var now =  new Date(Date.now())

                    var message = {
                        message_id: messageId,
                        text: messageInput.value,
                        sender: userIdInput.value,
                        sent_at: now.toISOString()
                    }

                    // Sending Message
                    socket.send(JSON.stringify(message));

                    displayOutgoingChatMessage(message)
                    
                    // Lock the user id value and remove focus
                    userIdInput.readOnly = true
                    userIdInput.blur()

                    // Reset message input and focus element
                    messageInput.value = ""
                    messageInput.focus()

                    messageId++

                    return false;
                };
            }

            function displayStatusMessage(message, success) {
                var messageList = document.getElementById("messageList")

                var newMessageWrapper = document.createElement("div")
                var newMessage = document.createElement("div")
                msg = document.createTextNode(message)
                newMessageWrapper.appendChild(newMessage)
                newMessage.appendChild(msg)

                if (success) {
                    newMessage.classList.add('bg-green-200')
                }
                else {
                    newMessage.classList.add('bg-red-200')
                } 

                addPillStyling(newMessageWrapper, newMessage)
                newMessageWrapper.classList.add('justify-center')

                messageList.appendChild(newMessageWrapper)
            }

            function displayIncommingChatMessage(data) {
                var messageList = document.getElementById("messageList")                
                var newMessageWrapper = document.createElement("div")
                var newMessage = createMessageElement(data)
                newMessageWrapper.appendChild(newMessage)
                
                addPillStyling(newMessageWrapper, newMessage)
                newMessage.classList.add('bg-gray-200')

                messageList.appendChild(newMessageWrapper)
            }

            function displayOutgoingChatMessage(data) {
                var messageList = document.getElementById("messageList")                
                var newMessageWrapper = document.createElement("div")
                var newMessage = createMessageElement(data)
                newMessageWrapper.appendChild(newMessage)
                
                addPillStyling(newMessageWrapper, newMessage)
                newMessage.classList.add('bg-blue-400')
                newMessageWrapper.classList.add('justify-end')


                messageList.appendChild(newMessageWrapper)
            }

            function createMessageElement(data) {
                var newMessage = document.createElement("div")
                var newMessageHeader = document.createElement("div")

                // Timestamp
                var date = new Date(data.sent_at)
                var sentAtValue = document.createTextNode(date.getHours() + ":" + date.getMinutes())
                var sentAtElement = document.createElement("div")
                sentAtElement.appendChild(sentAtValue)
                newMessageHeader.appendChild(sentAtElement)

                sentAtElement.classList.add('justify-end')
                sentAtElement.classList.add('pr-1')
                sentAtElement.classList.add('text-xs')
                sentAtElement.classList.add('object-bottom')
                sentAtElement.classList.add('text-xs')
                sentAtElement.classList.add('text-gray-900')

                // Sender
                var senderValue = document.createTextNode(data.sender)
                var senderElement = document.createElement("div")
                senderElement.appendChild(senderValue)
                newMessageHeader.appendChild(senderElement)
                

                // Header with timestamp and sender
                newMessage.appendChild(newMessageHeader)

                newMessageHeader.classList.add('flex')
                newMessageHeader.classList.add('flex-row')
                newMessageHeader.classList.add('items-baseline')


                // Message
                var textValue = document.createTextNode(data.text)
                var textElement = document.createElement("div")
                textElement.appendChild(textValue)
                newMessage.appendChild(textElement)

                return newMessage
            }

            function addPillStyling(messageWrapper, message) {
                messageWrapper.classList.add('flex')
                messageWrapper.classList.add('mb-1')
                message.classList.add('flex-initial')
                message.classList.add('max-w-2xl')
                message.classList.add('px-3')
                message.classList.add('py-1')
                message.classList.add('rounded-3xl')
            }

            function resetInputFields() {
                document.getElementById("userIdInput").value = ""
                document.getElementById("messageInput").value = ""
            }

        </script>
    </head>
    <body>

        <div id="app" class="font-sans h-screen flex flex-col flex-1">

            <div id="topbar" class="p-5 bg-black flex-grow-0 flex flex-row items-baseline">
                <div class="text-white font-bold text-6xl pr-4">Scale-Chat</div>
                <div class="text-gray-200 text-xl">Democlient</div>
            </div>

            <div id="messageList" class="flex-grow flex flex-col p-5 flex-wrap">
            </div>
    
            <form id="inputArea" class="flex-grow-0 p-5 bg-gray-600">
                <label for="userIdInput" class="pr-2 text-white">User Id:</label>
                <input id="userIdInput" type="text" autofocus class="p-1 rounded w-32 pr-2"/>
                <label for="messageInput" class="px-2 text-white">Message:</label>
                <input id="messageInput" type="text" class="p-1 rounded"/>
                <input type="submit" value="Send" class="btn px-4 py-1 rounded ml-2"> 
            </form>
        </div>
    </body>
</html>
