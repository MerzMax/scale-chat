<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Scale-Chat</title>
        <script>

            window.onload = function () {

                if (!("WebSocket" in window)) {
                    alert("WebSocket NOT supported by your Browser!");
                }
                else {
                    let socket = new WebSocket("ws://127.0.0.1:8080/ws");

                    // RECEIVING MESSAGES

                    socket.onopen = function(event) {
                        displayStatusMessage("Connection established!")
                    }

                    socket.onclose = function(event) {
                        if (event.wasClean) {
                            displayStatusMessage(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`)
                        } else {
                            displayStatusMessage("[close] Connection died (e.g. server process killed or network down)")
                        }
                    }

                    socket.onerror = function(error) {
                        console.log(`Error: ${error.message}`);
                    }

                    socket.onmessage = function(event) {
                        var messageList = document.getElementById("messageList")
                        var newMessage = document.createElement("div")
                        newMessage.classList.add('message')

                        var data = JSON.parse(event.data)
                        
                        // Timestamp
                        var date = new Date(data.sent_at)
                        var sentAtValue = document.createTextNode(date.getHours() + ":" + date.getMinutes())
                        var sentAtElement = document.createElement("div")
                        sentAtElement.appendChild(sentAtValue)
                        newMessage.appendChild(sentAtElement)

                        // Sender
                        var senderValue = document.createTextNode(data.sender)
                        var senderElement = document.createElement("div")
                        senderElement.appendChild(senderValue)
                        newMessage.appendChild(senderElement)

                        // Message
                        var textValue = document.createTextNode(data.text)
                        var textElement = document.createElement("div")
                        textElement.appendChild(textValue)
                        newMessage.appendChild(textElement)

                        messageList.appendChild(newMessage)
                    }
                    
                    // SENDING MESSAGES
                    document.getElementById("inputArea").onsubmit = function () {
                        if (!socket) {
                            displayStatusMessage("No WebSocket connection established. Reload to retry");
                            return false;
                        }
                        else if (!userIdInput.value) {
                            displayStatusMessage("Please input a user id.")
                            return false;
                        } 
                        else if(!messageInput.value) {
                            displayStatusMessage("Please input a message.")
                            return false;
                        }

                        var now =  new Date(Date.now())

                        var message = {
                            text: messageInput.value,
                            sender: userIdInput.value,
                            sent_at: now.toISOString()
                        }

                        // Sending Message
                        socket.send(JSON.stringify(message));
                        
                        // Lock the user id value and remove focus
                        userIdInput.readOnly = true
                        userIdInput.blur()

                        // Reset message input and focus element
                        messageInput.value = ""
                        messageInput.focus()

                        return false;
                    };
                }
                
            }

            function displayStatusMessage(message) {
                var messageList = document.getElementById("messageList")

                var newMessage = document.createElement("div")
                newMessage.classList.add('statusMessage')
                msg = document.createTextNode(message)
                newMessage.appendChild(msg)

                messageList.appendChild(newMessage)
            }

        </script>
        <style>
            #app{
                margin: 15px;
            }

            .message{

            }
            .statusMessage{

            }
        </style>

    </head>
    <body>

        <div id="app">

            <div id="topbar">
                <div>Scale-Chat</div>
            </div>

            <div id="messageList">
            </div>
    
            <form id="inputArea">
                <label for="userIdInput">User Id:</label>
                <input id="userIdInput" type="text" autofocus/>
                <label for="messageInput">Message:</label>
                <input id="messageInput" type="text"/>
                <input type="submit" value="Send"> 
            </form>
        </div>

        

    </body>
</html>
